<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1e40af" />
  <meta name="description" content="Inspe√ß√£o Semanal de Seguran√ßa (ISS) - Gest√£o de Seguran√ßa e Sa√∫de para Contratadas de Investimentos" />
  <title>ISS - Inspe√ß√£o Semanal de Seguran√ßa</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" type="image/png" href="./icons/icon-192x192.png" />
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-3d@2.0.1/dist/chartjs-plugin-3d.min.js"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  
  <style>
    body { font-family: 'Inter', sans-serif; }
    .accordion-content { display: none; transition: max-height 0.2s ease-out; }
    .accordion-button.open + .accordion-content { display: block; }
    .result-bar { transition: width 0.5s ease-in-out; }
    .concept-impedido { background-color: #EF4444; color: #fff; }
    .concept-pessimo { background-color: #D97706; color: #fff; }
    .concept-ruim { background-color: #F97316; color: #fff; }
    .concept-regular { background-color: #F59E0B; color: #fff; }
    .concept-melhorias { background-color: #84CC16; color: #fff; }
    .concept-otimo { background-color: #22C55E; color: #fff; }
    .concept-erro { background-color: #71717A; color: #fff; }
    
    /* PWA Install Prompt */
    #install-prompt {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1e40af;
      color: white;
      padding: 12px;
      text-align: center;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: none;
    }
    
    #install-prompt button {
      background: white;
      color: #1e40af;
      border: none;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    
    /* Offline indicator */
    #offline-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #EF4444;
      color: white;
      padding: 8px;
      text-align: center;
      z-index: 1000;
      display: none;
    }

    /* Install button in header */
    #install-btn-header {
      background: #1e40af;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      margin-left: 10px;
      display: none;
    }

    /* Online indicator */
    #online-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #22C55E;
      color: white;
      padding: 8px;
      text-align: center;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Connection Indicators -->
  <div id="offline-indicator">
    ‚ö†Ô∏è Voc√™ est√° offline. Algumas funcionalidades podem estar limitadas.
  </div>
  
  <div id="online-indicator">
    ‚úÖ Conex√£o restaurada
  </div>
  
  <!-- Install Prompt -->
  <div id="install-prompt">
    <p>üì± Instalar aplicativo ISS para uma melhor experi√™ncia</p>
    <button id="install-btn">Instalar</button>
    <button id="dismiss-install">Agora n√£o</button>
  </div>

  <div class="container mx-auto p-4 md:p-8 max-w-4xl">
    <header class="bg-white shadow-md rounded-xl p-6 mb-8 flex flex-col sm:flex-row items-center gap-4">
      <img id="logo-img" alt="Logo" class="h-10 w-auto" />
      <div class="flex-1 text-center sm:text-left">
        <h1 class="text-2xl md:text-3xl font-bold text-blue-800">INSPE√á√ÉO SEMANAL DE SEGURAN√áA (ISS)</h1>
        <p class="text-sm md:text-base text-gray-600 mt-1">GEST√ÉO DE SEGURAN√áA E SA√öDE PARA CONTRATADAS DE INVESTIMENTOS</p>
      </div>
      <button id="install-btn-header" class="hidden">üì≤ Instalar App</button>
    </header>

    <form id="inspection-form" class="space-y-6">
      <div class="bg-white shadow-md rounded-xl p-6">
        <h2 class="text-xl font-bold mb-4 border-b pb-2">Informa√ß√µes Gerais</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
          <input type="text" id="gerencia" placeholder="Ger√™ncia" class="p-2 border rounded-md" />
          <input type="text" id="contrato" placeholder="N¬∞ do Contrato" class="p-2 border rounded-md" />
          <input type="text" id="admin_contrato" placeholder="Administrador de Contrato" class="p-2 border rounded-md" />
          <input type="text" id="obra" placeholder="Obra" class="p-2 border rounded-md" />
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <input type="text" id="engenheiro" placeholder="Engenheiro / Supervisor" class="p-2 border rounded-md" />
            <input type="text" id="matricula_engenheiro" placeholder="Matricula Bancodoc" class="p-2 border rounded-md" />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <input type="text" id="sesmt" placeholder="Profissional do SESMT" class="p-2 border rounded-md" />
            <input type="text" id="matricula_sesmt" placeholder="Matricula Bancodoc" class="p-2 border rounded-md" />
          </div>
          <input type="text" id="atividades" placeholder="Descri√ß√£o das Atividades" class="p-2 border rounded-md md:col-span-2" />
          <input type="text" id="np" placeholder="NP" class="p-2 border rounded-md" />
          <input type="text" id="inspecao_no" placeholder="Inspe√ß√£o No." class="p-2 border rounded-md" />
          <input type="date" id="data" class="p-2 border rounded-md" title="Data" />
          <input type="time" id="hora" class="p-2 border rounded-md" title="Hora" />
        </div>
      </div>

      <div id="accordion-container" class="space-y-4"></div>

      <div class="bg-white shadow-md rounded-xl p-6">
        <h2 class="text-xl font-bold mb-4 border-b pb-2">N√£o Conformidades Encontradas</h2>
        <p class="text-sm text-gray-600 mb-2">
          Descreva abaixo as n√£o conformidades observadas (uma por linha, se desejar list√°-las separadamente).
        </p>
        <textarea id="nao_conformidades" rows="6" class="w-full border rounded-md p-3" placeholder="Ex.: Item 2.12 - Materiais soltos no andaime; Item 8.11 - Cabos no piso, etc."></textarea>
      </div>

      <div class="bg-white shadow-md rounded-xl p-6 flex flex-col md:flex-row items-center justify-between gap-4">
        <div id="result-container" class="w-full md:w-2/3 hidden">
          <div class="flex justify-between items-center mb-1">
            <span class="text-lg font-semibold">Resultado: <span id="percentage-text" class="font-bold">0.00%</span></span>
            <span id="concept-badge" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-4">
            <div id="result-bar" class="h-4 rounded-full result-bar bg-gray-400" style="width:0%"></div>
          </div>
        </div>
        <button type="button" id="generate-pdf" class="w-full md:w-auto bg-blue-800 hover:bg-blue-900 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg">
          Finalizar e Gerar PDF
        </button>
      </div>
    </form>
  </div>

  <script>
    // ========= PWA FUNCTIONALITY =========
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // Primeiro tenta o caminho relativo
        navigator.serviceWorker.register('./sw.js')
          .then(function(registration) {
            console.log('Service Worker registrado com sucesso: ', registration.scope);
            registration.update();
          })
          .catch(function(error) {
            console.log('Falha ao registrar Service Worker com caminho relativo: ', error);
            // Tenta caminho absoluto
            navigator.serviceWorker.register('/PWA_ISS/sw.js')
              .then(function(registration) {
                console.log('Service Worker registrado com caminho absoluto: ', registration.scope);
              })
              .catch(function(error2) {
                console.log('Falha tamb√©m com caminho absoluto: ', error2);
              });
          });
      });
    }

    // Online/Offline Detection
    function showOnlineIndicator() {
      const indicator = document.getElementById('online-indicator');
      indicator.style.display = 'block';
      setTimeout(() => {
        indicator.style.display = 'none';
      }, 3000);
    }

    window.addEventListener('online', function() {
      document.getElementById('offline-indicator').style.display = 'none';
      showOnlineIndicator();
      console.log('Aplica√ß√£o online');
    });

    window.addEventListener('offline', function() {
      document.getElementById('offline-indicator').style.display = 'block';
      console.log('Aplica√ß√£o offline');
    });

    // Check initial connection status
    if (!navigator.onLine) {
      document.getElementById('offline-indicator').style.display = 'block';
    } else {
      // Mostra indicador online por 2 segundos ao carregar
      setTimeout(showOnlineIndicator, 1000);
    }

    // PWA Install Prompt
    let deferredPrompt;
    const installPrompt = document.getElementById('install-prompt');
    const installBtn = document.getElementById('install-btn');
    const dismissBtn = document.getElementById('dismiss-install');
    const installBtnHeader = document.getElementById('install-btn-header');

    window.addEventListener('beforeinstallprompt', function(e) {
      console.log('beforeinstallprompt event fired');
      // Prevenir que o prompt apare√ßa automaticamente
      e.preventDefault();
      // Guardar o evento para usar depois
      deferredPrompt = e;
      
      // Mostrar nossos prompts personalizados
      installPrompt.style.display = 'block';
      installBtnHeader.style.display = 'block';
      
      // Opcional: esconder ap√≥s 30 segundos
      setTimeout(function() {
        if (installPrompt.style.display === 'block') {
          installPrompt.style.display = 'none';
        }
      }, 30000);
    });

    installBtn.addEventListener('click', function() {
      if (!deferredPrompt) return;
      
      // Esconder nosso prompt
      installPrompt.style.display = 'none';
      installBtnHeader.style.display = 'none';
      
      // Mostrar o prompt de instala√ß√£o do navegador
      deferredPrompt.prompt();
      
      // Aguardar resposta do usu√°rio
      deferredPrompt.userChoice.then(function(choiceResult) {
        if (choiceResult.outcome === 'accepted') {
          console.log('Usu√°rio aceitou a instala√ß√£o');
        } else {
          console.log('Usu√°rio recusou a instala√ß√£o');
        }
        deferredPrompt = null;
      });
    });

    installBtnHeader.addEventListener('click', function() {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      
      deferredPrompt.userChoice.then(function(choiceResult) {
        if (choiceResult.outcome === 'accepted') {
          console.log('Usu√°rio aceitou a instala√ß√£o via bot√£o do cabe√ßalho');
          installBtnHeader.style.display = 'none';
        } else {
          console.log('Usu√°rio recusou a instala√ß√£o via bot√£o do cabe√ßalho');
        }
        deferredPrompt = null;
      });
    });

    dismissBtn.addEventListener('click', function() {
      installPrompt.style.display = 'none';
    });

    // Verificar se o app j√° est√° instalado
    window.addEventListener('appinstalled', function(evt) {
      console.log('Aplicativo ISS instalado com sucesso');
      installPrompt.style.display = 'none';
      installBtnHeader.style.display = 'none';
    });

    // Verificar no carregamento se j√° est√° instalado
    if (window.matchMedia('(display-mode: standalone)').matches) {
      console.log('Executando como PWA instalado');
      installBtnHeader.style.display = 'none';
    }

      // ========= LOGO MANAGEMENT =========
  let logoDataUrl = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjUwIiB2aWV3Qm94PSIwIDAgMjAwIDUwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iNTAiIGZpbGw9IiMxZTQwYWIiLz48dGV4dCB4PSIxMCIgeT0iMzAiIGZpbGw9IndoaXRlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiPklTUyAtIExvZ290aXBvPC90ZXh0Pjwvc3ZnPg==";
  
  const LOGO_CANDIDATES = [
    "./icons/logo.png", // Logo local como fallback
    "https://raw.githubusercontent.com/Reblix/dados-iss/main/xl/media/image1.png",
    "https://raw.githubusercontent.com/Reblix/dados-iss/main/xl/media/image2.png",
    "https://raw.githubusercontent.com/Reblix/dados-iss/main/xl/media/image3.png",
    "https://raw.githubusercontent.com/Reblix/dados-iss/main/logo.png",
    "https://raw.githubusercontent.com/Reblix/dados-iss/main/media/logo.png"
  ];

  // Fun√ß√£o para carregar logo com fallback offline
  async function loadLogoWithFallback() {
    const logoImgEl = document.getElementById('logo-img');
    
    // Tenta carregar do cache primeiro
    for (const url of LOGO_CANDIDATES) {
      try {
        let response;
        
        if (url.startsWith('./')) {
          // URL local - tenta do cache
          const cache = await caches.open('iss-app-v4.0.0');
          response = await cache.match(url);
        } else {
          // URL externa - tenta do cache primeiro
          const cache = await caches.open('iss-app-v4.0.0');
          response = await cache.match(url);
          
          // Se n√£o encontrou no cache e est√° online, tenta fazer fetch
          if (!response && navigator.onLine) {
            response = await fetch(url, { cache: "force-cache" });
            if (response.ok) {
              // Adiciona ao cache para uso futuro
              cache.put(url, response.clone());
            }
          }
        }
        
        if (response && response.ok) {
          const blob = await response.blob();
          logoDataUrl = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
          break;
        }
      } catch (error) {
        console.log('Falha ao carregar logo:', url, error);
        continue;
      }
    }
    
    logoImgEl.src = logoDataUrl;
    return logoDataUrl;
  }

  // ========= APPLICATION CODE =========
  document.addEventListener('DOMContentLoaded', async function() {
    // Carrega o logo assim que poss√≠vel
    await loadLogoWithFallback();

      // ========= DADOS DOS ITENS (mapeados do original) =========
      const formItems = [
        { category: '1. Controle Sist√™mico (APR / PT)', items: [
          { id: '1.1', text: 'O servi√ßo possui APR e PT, que contemplam os cen√°rios de riscos? Todos os campos foram preenchidos corretamente?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '1.2', text: 'A APR √© de conhecimento, est√° assinada por todos os executantes da tarefa e dispon√≠vel na frente de servi√ßo? Toda lideran√ßa da contratada foi treinada nos padr√µes de APR e PT?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '1.3', text: "As tarefas da APR, est√£o de acordo com o potencial de severidade em fun√ß√£o do cen√°rio? Foram emitidas PT's para os riscos cr√≠ticos aplic√°veis aos investimentos?", barrier: 'Sist√™mica', potential: 'A' },
          { id: '1.4', text: 'A APR possui medidas coletivas preventivas adequadas e as mesmas est√£o implementadas?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '1.5', text: 'A PT foi emitida e liberada por profissionais treinados e autorizados?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '1.6', text: 'H√° indica√ß√£o formal do gestor da contratada para os emitentes ou liberadores de PT? As indica√ß√µes est√£o atualizadas?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '1.7', text: 'Os trabalhadores sabem o procedimento em caso de incidente, acidente ou emerg√™ncia?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '1.8', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '2. Andaimes', items: [
          { id: '2.1', text: 'Os andaimes est√£o nivelados, aprumados,alinhados, estaiados ou travados e sinalizados corretamente?', barrier: 'F√≠sica', potential: 'A' },
          { id: '2.2', text: 'Os andaimes s√£o montados/desmontados por profissionais qualificados?', barrier: 'F√≠sica', potential: 'A' },
          { id: '2.3', text: 'O check-list de libera√ß√£o de montagem foi preenchido corretamente e est√£o no prazo?', barrier: 'Comportamental', potential: 'A' },
          { id: '2.4', text: 'O risco de abalroamento contra o andaime est√° controlado (ponte rolante, EMVI,tubula√ß√µes, redes el√©tricas,pontos quentes, etc..)?', barrier: 'F√≠sica', potential: 'A' },
          { id: '2.5', text: 'A √°rea isolada em torno do andaime, ou trabalhos em altura, corresponde a uma dist√¢ncia segura durante a montagem, desmontagem e em uso?', barrier: 'F√≠sica', potential: 'A' },
          { id: '2.6', text: 'A torre isolada tem altura m√°xima igual a 4 vezes a menor largura da base?', barrier: 'F√≠sica', potential: 'A' },
          { id: '2.7', text: 'O piso est√° afixado a estrutura, sem aberturas, rachaduras e madeiras podres e com n√≥?', barrier: 'F√≠sica', potential: 'A' },
          { id: '2.8', text: 'O guarda corpo possui travessas com 1,20m e 0,70m de altura e possui rodap√© de 0,20m de altura?', barrier: 'F√≠sica', potential: 'A' },
          { id: '2.9', text: 'Est√° sendo cumprida a proibi√ß√£o de montar, desmontar, descer, subir com condi√ß√µes clim√°ticas adversas (chuvas, ventos fortes, nevoeiros)?', barrier: 'Comportamental', potential: 'A' },
          { id: '2.10', text: 'As escadas de acesso est√£o bem afixadas e seguras(degraus uniformes entre 25 a 30cm)?', barrier: 'F√≠sica', potential: 'B' },
          { id: '2.11', text: 'Escadas de acesso acima de 3m possui gaiola de prote√ß√£o e/ou trava-quedas?', barrier: 'F√≠sica', potential: 'A' },
          { id: '2.12', text: 'H√° materiais, ferramentas e pe√ßas de montagens soltas nos andaimes?', barrier: 'Comportamental', potential: 'B' },
          { id: '2.13', text: 'Os acessos e corredores dos andaimes est√£o obstru√≠dos?', barrier: 'Comportamental', potential: 'B' },
          { id: '2.14', text: 'O andaime possui placa de identifica√ß√£o e libera√ß√£o?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '2.15', text: 'A sinaliza√ß√£o est√° de acordo com uso do andaime?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '2.16', text: 'Andaimes m√≥veis possuem trava nos rod√≠zios?', barrier: 'F√≠sica', potential: 'A' },
          { id: '2.17', text: 'Existe regra espec√≠fica para movimenta√ß√£o com a plataforma isenta de materiais e colaboradores?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '2.18', text: 'Foi realizado o pr√©-uso do andaime e as medidas de controle atende?', barrier: 'Comportamental', potential: 'A' },
          { id: '2.19', text: 'Os andaimes acima de 6 metros e/ou em balan√ßo possuem projeto e c√°lculo estrutural com ART?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '2.20', text: 'As pilhas de material para montagem ou desmontagem de pe√ßas est√£o armazenadas de forma e altura que garantam a sua estabilidade e facilitem o seu manuseio?', barrier: 'F√≠sica', potential: 'B' },
          { id: '2.21', text: 'O andaime est√° devidamente aterrado e conferido por profissional qualificado? Ou sua instala√ß√£o foi orientada por profissional qualificado?', barrier: 'F√≠sica', potential: 'B' },
          { id: '2.22', text: 'Os gaveteiros de andaime montados nas √°reas onde existem risco de queda de materiais em n√≠veis inferiores est√£o distantes de guarda corpos das passarelas e plataformas ou com prote√ß√£o contra queda?', barrier: 'F√≠sica', potential: 'B' },
          { id: '2.23', text: 'Foi realizado pr√© uso do andaime pelos usu√°rios, verificando suas condi√ß√µes e interfer√™ncias?', barrier: 'F√≠sica', potential: 'B' },
          { id: '2.24', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '3. Arma√ß√µes de A√ßo', items: [
          { id: '3.1', text: 'A dobragem e corte de ferro √© feita sobre bancada ou plataformas apropriadas e est√°veis?', barrier: 'Comportamental', potential: 'B' },
          { id: '3.2', text: 'O local destinado a corte, dobra e movimenta√ß√£o de ferro √© cercado, fora de √°rea de circula√ß√£o?', barrier: 'F√≠sica', potential: 'C' },
          { id: '3.3', text: 'O piso √© resistente, nivelado e antiderrapante, com cobertura contra intemp√©ries e quedas de materiais?', barrier: 'F√≠sica', potential: 'B' },
          { id: '3.4', text: 'As l√¢mpadas de ilumina√ß√£o est√£o protegidas contra impactos?', barrier: 'F√≠sica', potential: 'C' },
          { id: '3.5', text: 'Todas as pontas de vergalh√µes existentes na obra, canteiros e p√°tios de estocagem com risco de contato e perfura√ß√£o de pessoas est√£o protegidas?', barrier: 'F√≠sica', potential: 'C' },
          { id: '3.6', text: 'Existem pranchas de madeira para circula√ß√£o de pessoas sobre arma√ß√µes?', barrier: 'F√≠sica', potential: 'C' },
          { id: '3.7', text: 'Os servi√ßos √† quente e o uso de ferramentas manuais possuem medidas de prote√ß√µes coletivas para as demais equipes de arma√ß√£o?', barrier: 'F√≠sica', potential: 'C' },
          { id: '3.8', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '4. Carga Suspensa', items: [
          { id: '4.1', text: 'O operador √© qualificado e certificado para o equipamento de guindar e/ou guindauto utilizado?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '4.2', text: 'O operador tem conhecimento sobre o peso da carga e as patolas est√£o 100% abertas?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '4.3', text: 'O RIGGER e operador do Equipamento, est√£o exercendo a autoridade de parar a movimenta√ß√£o por falta de isolamento / sinaliza√ß√£o, presen√ßa de terceiros na √°rea isolada, etc..?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '4.4', text: 'O equipamento possui capacidade de carga m√°xima vis√≠vel?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '4.5', text: 'O equipamento atende aos requisitos da diretriz de risco critico Gerdau - EMVI?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '4.6', text: 'O equipamento est√° trabalhando respeitando a tabela de carga e est√° dispon√≠vel no equipamento?', barrier: 'Comportamental', potential: 'B' },
          { id: '4.7', text: 'Existe plano de Rigging emitido e aprovado por profissional qualificado (Gerdau / Contratada) para i√ßamentos considerados CR√çTICOS e est√° sendo cumprido?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '4.8', text: 'O i√ßamento est√° sendo realizado em condi√ß√µes clim√°ticas favor√°veis? (Dia claro, sem a presen√ßa de ventos e/ou intemp√©ries).', barrier: 'Sist√™mica', potential: 'B' },
          { id: '4.9', text: 'A carga, est√° sendo guiada por dispositivo de seguran√ßa adequado (cordas, etc...)?', barrier: 'F√≠sica', potential: 'B' },
          { id: '4.10', text: 'Os sinaleiros ou supervisores de i√ßamentos est√£o a uma dist√¢ncia segura da carga?', barrier: 'Comportamental', potential: 'B' },
          { id: '4.11', text: 'Os acess√≥rios de i√ßamentos (cabos de a√ßo, ganchos com travas , cintas, etc.) est√£o em boas condi√ß√µes e foram verificados pelo RIGGER / operador na inspe√ß√£o de pr√© uso?', barrier: 'F√≠sica', potential: 'A' },
          { id: '4.12', text: 'Est√° sendo usado o "quebra-quinas" sobre as quinas "vivas"?', barrier: 'F√≠sica', potential: 'B' },
          { id: '4.13', text: 'O Sinaleiro est√° treinado e identificado com colete alusivo? Operador atende somente os sinais emitidos pelo Sinaleiro?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '4.14', text: 'Existe um sistema eficaz de comunica√ß√£o entre Sinaleiro e Operador ?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '4.15', text: 'Outros:', barrier: 'Comportamental', potential: 'NP' },
        ]},
        { category: '5. Serra Circular de Bancada Fixa', items: [
          { id: '5.1', text: 'A serra circular √© dotada de mesa est√°vel com as polias totalmente protegidas ?', barrier: 'F√≠sica', potential: 'B' },
          { id: '5.2', text: 'A serra circular est√° aterrada?', barrier: 'F√≠sica', potential: 'B' },
          { id: '5.3', text: 'Existe bloqueio f√≠sico na bancada, com cadeado, para evitar o uso indevido da serra, com sinaliza√ß√£o de acesso restrito?', barrier: 'F√≠sica', potential: 'A' },
          { id: '5.4', text: 'O disco est√° afiado, travado e n√£o apresenta dentes trincados ou quebrados ?', barrier: 'F√≠sica', potential: 'A' },
          { id: '5.5', text: 'A serra √© provida de coifa protetora do disco, cutelo divisor e coletor de serragem ?', barrier: 'F√≠sica', potential: 'A' },
          { id: '5.6', text: 'A carpintaria possui sinaliza√ß√£o leg√≠vel e clara proibindo o corte de pe√ßas pequenas no disco de bancada?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '5.7', text: 'A ilumina√ß√£o √© adequada e as l√¢mpadas de ilumina√ß√£o est√£o protegidas contra impactos?', barrier: 'F√≠sica', potential: 'C' },
          { id: '5.8', text: 'O piso √© resistente, nivelado e antiderrapante, e existe cobertura para prote√ß√£o intemp√©ries?', barrier: 'F√≠sica', potential: 'C' },
          { id: '5.9', text: 'A carpitaria disp√µem de extintor no local, o colaborador foi treinado em combate a inc√™ndio?', barrier: 'F√≠sica', potential: 'B' },
          { id: '5.10', text: 'Os Operadores, est√£o identificados num quadro com as fotos dos mesmos e da supervis√£o e existe um procedimento de seguran√ßa formalizado com as devidas responsabilidades do operador / supervis√£o? O colaborador possui identifica√ß√£o pessoal conforme NR - 12 e NR - 18?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '5.11', text: 'Existe local adequado para armazenagem de madeira e o mesmo est√° organizado e identificado?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '5.12', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '6. Equipamento de Prote√ß√£o Individual', items: [
          { id: '6.1', text: 'Todos os colaboradores est√£o usando os EPIs b√°sicos, espec√≠ficos e em boas condi√ß√µes? Os EPIs s√£o adequados aos riscos das atividades? Quando aplic√°vel s√£o realizados pr√©-uso dos mesmos?', barrier: 'Comportamental', potential: 'B' },
          { id: '6.2', text: 'H√° evid√™ncias da exig√™ncia do uso dos EPIs nas frentes de servi√ßo pela supervis√£o da contratada? (DDS, Treinamentos)', barrier: 'Sist√™mica', potential: 'B' },
          { id: '6.3', text: 'As contratadas possuem estoque de EPIs no canteiro?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '6.4', text: 'O recolhimento e descarte dos EPIs atendem os requisitos ambientais?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '6.5', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '7. Bloqueio de Fontes de Energia', items: [
          { id: '7.1', text: 'O Mapa de Bloqueio de Energia, foi preenchido, seguido e todas as fontes de energia est√£o bloqueadas?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '7.2', text: 'Os colaboradores est√£o treinados no procedimento de Bloqueio de fontes de energia?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '7.3', text: 'Todos os colaboradores cumprem o padr√£o de bloqueio de fonte de energia?', barrier: 'Comportamental', potential: 'A' },
          { id: '7.4', text: 'Todos os envolvidos na atividade, possuem seus cadeados e etiqueta individuais, com telefone, nome da empresa e foto?', barrier: 'F√≠sica', potential: 'A' },
          { id: '7.5', text: 'Foi preenchido na PT - Trabalho com fontes de energias perigosas e seguem os 6 passos?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '7.6', text: 'Foi feito o aterramento do sistema por profissional qualificado antes do ponto de trabalho?', barrier: 'F√≠sica', potential: 'A' },
          { id: '7.7', text: 'A contratada est√° cumprindo o protocolo do risco cr√≠tico - Bloqueio de Fontes de Energia?', barrier: 'Comportamental', potential: 'A' },
          { id: '7.8', text: 'A contratada tem ci√™ncia cumpre os procedimentos espec√≠ficos para servi√ßos el√©tricos da Unidade?', barrier: 'Comportamental', potential: 'A' },
          { id: '7.9', text: 'Outros:', barrier: 'F√≠sica', potential: 'A' },
        ]},
        { category: '8. Eletricidade', items: [
          { id: '8.1', text: 'A empresa autoriza somente colaboradores capacitados ou qualificados, habilitados e com os EPIs espec√≠ficos conforme NR10 para executar atividades com eletricidade?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '8.2', text: 'Todos os equipamentos el√©tricos port√°teis possuem pr√© uso?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '8.3', text: 'Todos os equipamentos el√©tricos port√°teis possuem selo de inspe√ß√£o Gerdau?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '8.4', text: 'H√° validade do selo est√° em dia?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '8.5', text: 'O risco de contato acidental com componentes energizados est√° controlado?', barrier: 'F√≠sica', potential: 'A' },
          { id: '8.6', text: 'Os EPIs e feramentas utilizados para interven√ß√£o nas instala√ß√µes el√©tricas s√£o adequados a voltagem?', barrier: 'F√≠sica', potential: 'A' },
          { id: '8.7', text: 'Os EPIs para trabalhar em instala√ß√µes est√£o em boas condi√ß√µes, v√°lidos e com os testes dentro do prazo?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '8.8', text: 'Todos os pain√©is fixo, mov√©is e tomadas el√©tricas est√£o identificados corretamente e limpos?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '8.9', text: 'Todos os pain√©is el√©tricos possuem disjuntores diferenciais residuais de seguran√ßa (DR)?', barrier: 'F√≠sica', potential: 'A' },
          { id: '8.10', text: 'Todas as tomadas possuem pino de aterramento ou o equipamento est√£o isolado?', barrier: 'F√≠sica', potential: 'A' },
          { id: '8.11', text: 'Os cabos e extens√µes el√©tricas s√£o mantidos suspensos e em boas condi√ß√µes?', barrier: 'F√≠sica', potential: 'B' },
          { id: '8.12', text: 'As m√°quinas e equipamentos pr√≥ximos a rede el√©trica est√£o aterrados e os trabalhos pr√≥ximos a alta tens√£o respeitam a dist√¢ncia de 3m?', barrier: 'F√≠sica', potential: 'A' },
          { id: '8.13', text: 'Formul√°rio de perfura√ß√£o (piso/parade e escava√ß√£o), esta liberado pelo eletricista?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '8.14', text: 'O colaborador da contratada est√° com o selo de autoriza√ß√£o para atuar em eletricidade?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '8.15', text: 'Outros:', barrier: 'Sist√™mica', potential: 'NP' },
        ]},
        { category: '9. EMVI - Equipamentos M√≥veis / Ve√≠culos Industriais', items: [
          { id: '9.1', text: 'O EMVI possui Laudo de Inspe√ß√£o T√©cnico assinado por Profissional Habilitado? Os laudos est√£o atualizados?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '9.2', text: 'O EMVI possui as inspe√ß√µes de pr√©-uso preenchidas corretamente? H√° itens que interditam claramente o equipamento?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '9.3', text: 'Os operadores possuem qualifica√ß√£o, certifica√ß√£o, CNH (exceto para plataformas elevat√≥rias) e autoriza√ß√£o emitida pela empresa vigentes?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '9.4', text: 'O EMVI possui sua capacidade de carga m√°xima identificada?', barrier: 'F√≠sica', potential: 'C' },
          { id: '9.5', text: 'O EMVI possui cinto de seguran√ßa e os demais dispositivos de seguran√ßa funcionando?', barrier: 'F√≠sica', potential: 'B' },
          { id: '9.6', text: 'O EMVI esta dimensionado em fun√ß√£o da carga movimentada?', barrier: 'F√≠sica', potential: 'A' },
          { id: '9.7', text: 'Todos os equipamentos m√≥veis possuem alarme sonoro de R√© e ilumina√ß√£o de advert√™ncia?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '9.8', text: 'Existe pessoa qualificada, treinada e autorizada no solo para operar plataforma elevat√≥ria em caso de emerg√™ncia?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '9.9', text: 'O EMVI esta isento de vazamentos de √≥leo e/ou combust√≠veis?', barrier: 'F√≠sica', potential: 'C' },
          { id: '9.10', text: 'EMVI H√° kits de emerg√™ncia ambiental?', barrier: 'F√≠sica', potential: 'C' },
          { id: '9.11', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '10. Escadas, Rampas e Passarelas', items: [
          { id: '10.1', text: 'A escada de m√£o est√° posicionada em local isento de risco de contato acidental com equipamentos e redes el√©tricas?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '10.2', text: 'A escada de m√£o est√° amarrada ou sendo segura por outro colaborador?', barrier: 'F√≠sica', potential: 'B' },
          { id: '10.3', text: 'A escada de m√£o possui pr√© uso?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '10.4', text: 'As escadas, rampas e/ou passarelas est√£o dimensionadas de acordo com as cargas existentes?', barrier: 'F√≠sica', potential: 'C' },
          { id: '10.5', text: 'A escada, rampas e/ou passarela est√£o em boas condi√ß√µes de uso, sem trincas, rachaduras, abertura no piso e madeiras com n√≥?', barrier: 'F√≠sica', potential: 'C' },
          { id: '10.6', text: 'Os desn√≠veis de piso, possuem degraus, conforme NR 18?', barrier: 'F√≠sica', potential: 'C' },
          { id: '10.7', text: 'A escada, rampas e/ou passarela possuem guarda-corpo com travessas a 0,70 e 1,20m e rodap√©? As estruturas possuem resistencia conforme projeto?', barrier: 'F√≠sica', potential: 'A' },
          { id: '10.8', text: 'As rampas s√£o providas de pe√ßas transversais para apoio dos p√©s?', barrier: 'F√≠sica', potential: 'B' },
          { id: '10.9', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '11. Escava√ß√µes', items: [
          { id: '11.1', text: 'A PT com escava√ß√µes foi emitida,liberada e divulgada antes do in√≠cio das atividades,est√° na frente de servi√ßos e as prote√ß√µes coletivas est√£o sendo cumpridas?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '11.2', text: 'O risco de desmoronamento est√° controlado (rampas de 45¬∞ ou escoramento)?', barrier: 'F√≠sica', potential: 'A' },
          { id: '11.3', text: 'O acesso a escava√ß√£o √© seguro?', barrier: 'F√≠sica', potential: 'B' },
          { id: '11.4', text: 'H√° ilumina√ß√£o noturna quando aplic√°vel?', barrier: 'F√≠sica', potential: 'B' },
          { id: '11.5', text: 'A escava√ß√£o est√° sinalizada e com prote√ß√£o nas laterais?', barrier: 'F√≠sica', potential: 'B' },
          { id: '11.6', text: 'As prote√ß√µes s√£o resistentes contra queda de pessoas ou ve√≠culos?', barrier: 'F√≠sica', potential: 'B' },
          { id: '11.7', text: 'A escava√ß√£o permite a sa√≠da e o resgate r√°pido de colaboradores?', barrier: 'F√≠sica', potential: 'B' },
          { id: '11.8', text: 'Foi realizado simulado de emerg√™ncia, quando aplic√°vel?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '11.9', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '12. Espa√ßo Confinado', items: [
          { id: '12.1', text: 'A Contratada est√° cumprindo o protocolo do risco cr√≠tico espa√ßo confinado?', barrier: 'Comportamental', potential: 'A' },
          { id: '12.2', text: 'A Permiss√£o de Trabalho em Espa√ßo Confinado foi emitida,liberada, divulgada, fixada na entrada do espa√ßo confinado e est√° sendo cumprida?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '12.3', text: 'Existe um "vigia" qualificado em contato com as pessoas dentro do espa√ßo confinado?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '12.4', text: 'As pessoas que entraram no espa√ßo confinado deixaram os crach√°s com o vigia?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '12.5', text: 'Todos os envolvidos na atividade de espa√ßo confinado, possuem treinamento vigente e possuem identifica√ß√£o de habilita√ß√£o para trabalho em espa√ßo confinado?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '12.6', text: 'Todos das equipes envolvidas possuem treinamentos espec√≠fico no uso de carboximetro e ox√≠metro?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '12.7', text: 'Os colaboradores realizaram, etil√¥metria e aferi√ß√£o arterial?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '12.8', text: 'A Contratada tem procedimento de emerg√™ncia e realiza simulado conforme NR - 33?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '12.9', text: 'Todos os envolvidos na atividade est√£o de barba feita?', barrier: 'Comportamental', potential: 'B' },
          { id: '12.10', text: 'Cadastro de espa√ßo confinado esta anexo a APR?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '12.11', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '13. Ferramentas Manuais/ e ou Equipamentos Port√°teis El√©tricos', items: [
          { id: '13.1', text: 'As ferramentas port√°teis el√©tricas possuem duplo isolamento?', barrier: 'F√≠sica', potential: 'A' },
          { id: '13.2', text: 'Foi realizada a inspe√ß√£o de pr√©-uso nas ferramentas manuais el√©tricas e as n√£o conformidades foram resolvidas?', barrier: 'F√≠sica', potential: 'A' },
          { id: '13.3', text: 'H√° itens de pr√©-uso que interditam claramente as ferramentas el√©tricas?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '13.4', text: 'H√° pr√°tica de uso de ferramentas improvisadas?', barrier: 'Comportamental', potential: 'B' },
          { id: '13.5', text: 'As ferramentas est√£o livres de "cabe√ßas de cogumelo"?', barrier: 'F√≠sica', potential: 'B' },
          { id: '13.6', text: 'H√° dispositivos para fixa√ß√£o individual das ferramentas nos trabalhos em altura?', barrier: 'F√≠sica', potential: 'B' },
          { id: '13.7', text: 'As mangueiras das ferramentas pneum√°ticas, possuem engate com corrente de seguran√ßa?', barrier: 'F√≠sica', potential: 'B' },
          { id: '13.8', text: 'Tem bancada/eou cavalete dispon√≠vel, e esta sendo utilizada para realizar cortes em materiais?', barrier: 'F√≠sica', potential: 'B' },
          { id: '13.9', text: 'Existem biombos para proje√ß√£o de particulas?', barrier: 'F√≠sica', potential: 'B' },
          { id: '13.10', text: 'Outros: Falta de "m√£o-amiga" na frente de servi√ßo para auxiliar na instala√ß√£o de hastes de aterramento.', barrier: 'Fisica', potential: 'B' },
        ]},
        { category: '14. Controle de Risco de Inc√™ndio', items: [
          { id: '14.1', text: 'O equipamento oxi-acetil√™nico recebeu inspe√ß√£o de pr√©-uso? O formul√°rio possui itens que interditam claramente os equipamentos?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '14.2', text: 'Os servi√ßos √† quente com tarefa de potencial de severidade A e B, possui a APR e Permiss√£o de Trabalho?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '14.3', text: 'As duas mangueiras possuem v√°lvula contra retrocesso de chama junto a caneta a ao cilindro?', barrier: 'F√≠sica', potential: 'A' },
          { id: '14.4', text: 'Os leitos de cabos el√©tricos e vias de acesso e circula√ß√£o de pessoas est√£o protegidos contra fagulhas, respingos de solda e proje√ßa√µ de part√≠culas de ferramentas rotativas?', barrier: 'F√≠sica', potential: 'B' },
          { id: '14.5', text: 'Existe extintor de inc√™ndio na frente de servi√ßo e os mesmos est√£o adequados ao uso, limpos e desimpedidos?', barrier: 'F√≠sica', potential: 'B' },
          { id: '14.6', text: 'As equipes s√£o treinadas para combate a principios de inc√™ndio?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '14.7', text: 'Existe l√≠quido inflam√°vel com ponto de fulgor abaixo de 37,7¬∫ C e libera√ß√£o da FISPQ?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '14.8', text: 'Os produtos inflam√°veis e perigosos s√£o acondicionados e transportados corretamente?', barrier: 'F√≠sica', potential: 'A' },
          { id: '14.9', text: 'Os cilindros de g√°s, s√£o utilizados e transportado em p√© e presos aos carrinhos?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '14.10', text: 'Os cilindros de g√°s s√£o estocados adequadamente, amarrados e com capacete?', barrier: 'F√≠sica', potential: 'B' },
          { id: '14.11', text: 'Todos os extintores passaram por inspe√ß√£o mensal realizada pela contratada?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '14.12', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '15. Organiza√ß√£o, Higiene e Limpeza', items: [
          { id: '15.1', text: 'A √°rea de trabalho est√° limpa e organizada sem entulhos, sucatas e pontas de prego?', barrier: 'Comportamental', potential: 'C' },
          { id: '15.2', text: 'O armazenamento de materiais possui acesso f√°cil e corredores?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '15.3', text: 'Os res√≠duos gerados na obra est√£o devidamente separados e isentos de extremidades pontiagudas e/ou cortantes?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '15.4', text: 'Os res√≠duos gerados na obra s√£o descartados periodicamente em local apropriado?', barrier: 'Comportamental', potential: 'C' },
          { id: '15.5', text: 'O posto de trabalho possui √°gua pot√°vel e copos dispon√≠veis? H√° recepientes dimencionados corretamente para coleta dos mesmos?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '15.6', text: 'Os sanit√°rios e/ou vesti√°rios s√£o suficientes, adequados e limpos?', barrier: 'F√≠sica', potential: 'C' },
          { id: '15.7', text: 'Os sanit√°rios e/ou vesti√°rios disp√µem de material de higiene e limpeza?', barrier: 'F√≠sica', potential: 'C' },
          { id: '15.8', text: 'O vesti√°rio disp√µe de armarios limpos, identificados e com dispositivo de tranca para cada trabalhador?', barrier: 'F√≠sica', potential: 'C' },
          { id: '15.9', text: 'Os locais sem ilumina√ß√£o natural, foram dimensionados e est√° em funcionamento um sistema de ilumina√ß√£o artificial adequado?', barrier: 'F√≠sica', potential: 'C' },
          { id: '15.10', text: 'As plataformas de acesso est√£o isento de materiais de materiais com risco de queda no piso abaixo?', barrier: 'F√≠sica', potential: 'C' },
          { id: '15.11', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '16. Produtos Qu√≠micos', items: [
          { id: '16.1', text: 'As FISPQ est√£o dispon√≠veis na frente de servi√ßo,as pessoas envolvidas s√£o treinadas e as recomenda√ß√µes est√£o sendo seguidas?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '16.2', text: 'Os servi√ßos com produtos qu√≠micos, com tarefa de potencial de severidade A e B , possui a APR e Permiss√£o de Trabalho?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '16.3', text: 'O deposito de produtos qu√≠micos posuem sinaliza√ß√£o e prote√ß√£o contra inc√™ndios?', barrier: 'F√≠sica', potential: 'A' },
          { id: '16.4', text: 'As √°reas de estocagem provis√≥rias possuem prote√ß√£o contra derramamento acidental e s√£o adequados?', barrier: 'F√≠sica', potential: 'B' },
          { id: '16.5', text: 'Os produtos qu√≠micos em estocagem, s√£o compativ√©is?', barrier: 'F√≠sica', potential: 'B' },
          { id: '16.6', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '17. Quedas em Mesmo N√≠vel', items: [
          { id: '17.1', text: 'A √°rea de trabalho est√° livre de obst√°culos, materiais escorregadios e/ou sali√™ncias?', barrier: 'F√≠sica', potential: 'C' },
          { id: '17.2', text: 'As prote√ß√µes s√£o resistentes e est√£o fixadas corretamente?', barrier: 'F√≠sica', potential: 'C' },
          { id: '17.3', text: 'As aberturas no piso est√£o protegidas e identificadas?', barrier: 'F√≠sica', potential: 'C' },
          { id: '17.4', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '18. Trabalho em Altura / e ou Telhado', items: [
          { id: '18.1', text: 'Os servi√ßos em altura, acima de 2m, possui a APR, Permiss√£o de Trabalho e as mesmas est√£o sendo cumpridas?', barrier: 'Comportamental', potential: 'A' },
          { id: '18.2', text: 'Existe um plano de resgate para os colaboradores trabalhando em altura?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '18.3', text: 'As prote√ß√µes contra quedas, seja para acesso ou execu√ß√£o das tarefas, est√£o instaladas e usadas de acordo c/ os procedimentos de seguran√ßa e conforme projeto elaborado por profissional habilitado ?', barrier: 'F√≠sica', potential: 'A' },
          { id: '18.4', text: 'Todos os colaboradores envolvidos, est√£o treinados e identificados (carga hor√°ria 8h / reciclagem bienal)? Treinamento NR35', barrier: 'Sist√™mica', potential: 'A' },
          { id: '18.5', text: 'Existe linha de vida adequada para os colaboradores prenderem o cinto de seguran√ßa e os mesmos est√£o protegidos contra quedas 100% do tempo?', barrier: 'F√≠sica', potential: 'A' },
          { id: '18.6', text: 'Os pontos de ancoragem para cintos de seguran√ßa, foram definidos, sendo usados 100% do tempo e as ferramentas manuais est√£o amarradas? (linha de vida ou ancoragem provis√≥ria)', barrier: 'F√≠sica', potential: 'A' },
          { id: '18.7', text: 'O isolamento abaixo dos trabalhos em altura √© suficiente e est√£o sinalizados corretamente, conforme padr√£o Gerdau?', barrier: 'F√≠sica', potential: 'A' },
          { id: '18.8', text: 'Est√° sendo cumprida a proibi√ß√£o de utilizar adornos como: brincos, pulseiras, rel√≥gios, cord√µes, an√©is, etc?', barrier: 'Comportamental', potential: 'B' },
          { id: '18.9', text: 'Todas as ferramentas e materiais utilizados em altura est√£o amarrados?', barrier: 'Comportamental', potential: 'A' },
          { id: '18.10', text: 'As condi√ß√µes clim√°ticas est√£o favor√°veis( aus√™ncia de ventos fortes, chuvas, descargas atmosfericas e umidade) para execu√ß√£o da atividade?', barrier: 'F√≠sica', potential: 'A' },
          { id: '18.11', text: 'Existem pranch√µes (duraluminio antiderrapante) instalados adequadamente para os colaboradores pisarem, se necess√°rio?', barrier: 'F√≠sica', potential: 'A' },
          { id: '18.12', text: 'O telhado est√° livre do ac√∫mulo de ferramentas ou materiais pesados?', barrier: 'F√≠sica', potential: 'A' },
          { id: '18.13', text: 'A rede de prote√ß√£o contra quedas est√° instalada abaixo de 2 metros da √°rea de trabalho para atividades em altura com v√£os livres superiores √† 10 metros?', barrier: 'F√≠sica', potential: 'A' },
          { id: '18.14', text: 'As linhas de vida est√£o sinalizadas quanto a sua capacidade de carga e n√∫mero de pessoas?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '18.15', text: 'Realiza√ß√£o de Etilometria e aferi√ß√£o arterial?', barrier: 'Sist√™mica', potential: 'A' },
          { id: '18.16', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '19. Sinaliza√ß√£o / Isolamento de √Årea / Interfer√™ncias com √Årea Operacional', items: [
          { id: '19.1', text: 'As frentes de servi√ßos est√£o devidamente isoladas e sinalizadas, em sua totalidade?', barrier: 'F√≠sica', potential: 'B' },
          { id: '19.2', text: 'O isolamento atende a sua finalidade de prote√ß√£o f√≠sica do perigo?', barrier: 'F√≠sica', potential: 'B' },
          { id: '19.3', text: 'As placas de sinaliza√ß√£o est√£o limpas, conservadas e bem afixadas? H√° acesso espec√≠fico e seguro para as frentes de servi√ßos?', barrier: 'F√≠sica', potential: 'C' },
          { id: '19.4', text: 'Esta sendo utilizado barreira fisica (Biombos) onde a risco de proje√ß√£o de particulas, acessos indevidos ou isolamento de riscos operacionais?', barrier: 'F√≠sica', potential: 'A' },
          { id: '19.5', text: 'Todos os colaboradores das frentes de servi√ßos, pr√≥ximas √†s √°reas operacionais, conhecem os riscos espec√≠ficos a que est√£o expostos?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '19.6', text: 'Existem sinaliza√ß√£o de emerg√™ncia, caminho seguro e sentido de deslocamento em todas as frentes de servi√ßos?', barrier: 'F√≠sica', potential: 'B' },
          { id: '19.7', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '20. Concretagem', items: [
          { id: '20.1', text: 'O acesso ao local da concretagem √© seguro? H√° ilumina√ß√£o suficiente no ambiente de trabalho?', barrier: 'F√≠sica', potential: 'B' },
          { id: '20.2', text: 'Os vibradores s√£o aterrados e isolados?', barrier: 'F√≠sica', potential: 'B' },
          { id: '20.3', text: 'Os operadores de bomba e caminh√µes s√£o treinados e habilitados? Portam crach√° de identifica√ß√£o certificando o treinamento?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '20.4', text: 'A limpeza do mangote da bomba √© feita em local adequado?', barrier: 'Comportamental', potential: 'C' },
          { id: '20.5', text: 'A fixa√ß√£o do mangote √© adequada e existe dispositivo de seguran√ßa contra quedas?', barrier: 'F√≠sica', potential: 'B' },
          { id: '20.6', text: 'O caminh√£o bomba lan√ßa est√° devidamente patolado?', barrier: 'F√≠sica', potential: 'A' },
          { id: '20.7', text: 'As interfer√™ncias do equipamento (ex.: lan√ßador de concreto) com redes el√©tricas, equipamentos energizados, pontes rolantes e outros est√£o controladas?', barrier: 'F√≠sica', potential: 'A' },
          { id: '20.8', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
        { category: '21. Servi√ßos em Vias de Tr√¢nsito e Terraplenagem', items: [
          { id: '21.1', text: 'A Sinaliza√ß√£o de tr√¢nsito est√° adequada?', barrier: 'F√≠sica', potential: 'C' },
          { id: '21.2', text: 'H√° sinaleiros para todos os equipamentos m√≥veis e/ou frentes de servi√ßos?', barrier: 'F√≠sica', potential: 'C' },
          { id: '21.3', text: 'Existem "Leiras" com altura m√≠nima da metade da roda do maior ve√≠culo?', barrier: 'F√≠sica', potential: 'B' },
          { id: '21.4', text: 'Existe a disponibilidade de caminh√µes pipas suficientes, para umidifica√ß√£o e limpeza das vias?', barrier: 'F√≠sica', potential: 'C' },
          { id: '21.5', text: 'Todos os sinaleiros fazem uso do colete refletivo e apitos?', barrier: 'F√≠sica', potential: 'C' },
          { id: '21.6', text: 'Existe sistema de comunica√ß√£o, eficaz para controle de tr√°fego?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '21.7', text: 'H√° acesso seguro para pedestres, sinalizado e isolado?', barrier: 'F√≠sica', potential: 'B' },
          { id: '21.8', text: 'Outros:', barrier: 'Fisica', potential: 'B' },
        ]},
        { category: '22. Banheiro Qu√≠mico / √Årea de Viv√™ncia', items: [
          { id: '22.1', text: 'H√° banheiros qu√≠micos para cada 20 colaboradores em atividade? Est√£o instalados em local adequado?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '22.2', text: 'Est√£o mantidos em estado de asseio e higiene?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '22.3', text: 'Est√£o instalados em compartimentos individuais separados masculino e feminino?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '22.4', text: 'Est√£o dotados de portas providas de fecho (ocupado e vazio)?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '22.5', text: 'Est√£o dotados de ilumina√ß√£o e ventila√ß√£o adequadas?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '22.6', text: 'Possui recipientes com tampa para guardar papeis servidos?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '22.7', text: 'O local √© de f√°cil acesso e n√£o permitindo um deslocamento superior a 150m (posto de trabalho)?', barrier: 'Sist√™mica', potential: 'C' },
          { id: '22.8', text: 'O container tipo mar√≠timo, uso para escrit√≥rio, sanit√°rios e guarda de material, possui laudo de descontamina√ß√£o biol√≥gica e radiol√≥gica?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '22.9', text: 'O container atende o procedimento de insta√ß√£o Gerdau? (ateramento, libera√ß√£o da el√©trica, extintor de inc√™ndio)', barrier: 'Sist√™mica', potential: 'B' },
          { id: '22.10', text: 'A estocagem de materiais no container √© feita de forma ordenada, evitando a ocorr√™ncia de acidentes, obstru√ß√£o dos acessos ou queda de materiais?', barrier: 'Sist√™mica', potential: 'B' },
          { id: '22.11', text: 'As tendas instaladas em canteiros est√£o chumbadas em sua base e estaiadas com no m√≠nimo duas fixa√ß√µes para cada estaio (garantindo todos os pontos)? Possuem aterramento nas estruturas met√°licas? Foi projetada e montada de forma que n√£o acumule √°gua sobre a lona?', barrier: 'F√≠sica', potential: 'B' },
          { id: '22.12', text: 'Outros:', barrier: '', potential: 'NP' },
        ]},
      ];

      // ========= RENDER DOS ACCORDIONS =========
      const accordionContainer = document.getElementById('accordion-container');
      
      // Helper para gerar os bot√µes de r√°dio
      const generateRadioButtons = (itemId) => `
        <div class="flex justify-around items-center space-x-2">
          <label class="cursor-pointer flex items-center p-2 rounded-md hover:bg-gray-200 transition-colors">
            <input type="radio" name="item-${itemId}" value="C" class="mr-1 h-4 w-4"> C
          </label>
          <label class="cursor-pointer flex items-center p-2 rounded-md hover:bg-gray-200 transition-colors">
            <input type="radio" name="item-${itemId}" value="NC" class="mr-1 h-4 w-4"> NC
          </label>
          <label class="cursor-pointer flex items-center p-2 rounded-md hover:bg-gray-200 transition-colors">
            <input type="radio" name="item-${itemId}" value="NA" class="mr-1 h-4 w-4"> NA
          </label>
        </div>
      `;

      formItems.forEach((section, index) => {
        const sectionId = `section-${index}`;
        const sectionElement = document.createElement('div');
        sectionElement.className = 'bg-white shadow-md rounded-xl overflow-hidden';

        sectionElement.innerHTML = `
          <button type="button" class="accordion-button w-full text-left p-4 bg-gray-50 hover:bg-gray-200 focus:outline-none" data-target="#${sectionId}">
            <h3 class="text-lg font-bold flex justify-between items-center">
              <span>${section.category}</span>
              <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </h3>
          </button>
          <div id="${sectionId}" class="accordion-content p-4">
            <div class="hidden md:block overflow-x-auto">
              <table class="w-full border-collapse min-w-[600px]">
                <thead>
                  <tr class="bg-gray-100 text-sm">
                    <th class="border p-2 text-left">Item</th>
                    <th class="border p-2 text-left w-1/2">Condi√ß√£o</th>
                    <th class="border p-2 text-center">Barreira</th>
                    <th class="border p-2 text-center">Potencial</th>
                    <th class="border p-2 text-center" style="width: 180px;">Avalia√ß√£o</th>
                  </tr>
                </thead>
                <tbody>
                  ${section.items.map(item => `
                    <tr class="hover:bg-gray-50">
                      <td class="border p-2 font-semibold text-center">${item.id}</td>
                      <td class="border p-2 text-sm">${item.text}</td>
                      <td class="border p-2 text-sm text-center">${item.barrier}</td>
                      <td class="border p-2 font-bold text-center">${item.potential}</td>
                      <td class="border p-2">${generateRadioButtons(item.id)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>

            <div class="md:hidden space-y-4">
              ${section.items.map(item => `
                <div class="border rounded-lg p-4 bg-gray-50 shadow-sm">
                  <div class="font-bold text-base mb-2">Item ${item.id}</div>
                  <p class="text-sm text-gray-700 mb-3">${item.text}</p>
                  <div class="grid grid-cols-2 gap-2 text-sm mb-4">
                     <div class="bg-white p-2 rounded-md text-center">
                       <span class="font-semibold block">Barreira</span>
                       <span>${item.barrier || 'N/A'}</span>
                     </div>
                     <div class="bg-white p-2 rounded-md text-center">
                        <span class="font-semibold block">Potencial</span>
                        <span class="font-bold">${item.potential}</span>
                     </div>
                  </div>
                  <div class="bg-gray-200 p-1 rounded-lg">
                    ${generateRadioButtons(item.id)}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        accordionContainer.appendChild(sectionElement);
      });

      // Acordeon toggle
      document.querySelectorAll('.accordion-button').forEach(button => {
        button.addEventListener('click', () => {
          const content = document.querySelector(button.dataset.target);
          const icon = button.querySelector('svg');
          const isOpening = !button.classList.contains('open');

          document.querySelectorAll('.accordion-button.open').forEach(openButton => {
            if (openButton !== button) {
              openButton.classList.remove('open');
              openButton.querySelector('svg').classList.remove('rotate-180');
              document.querySelector(openButton.dataset.target).style.display = 'none';
            }
          });

          if (isOpening) {
            content.style.display = 'block';
            icon.classList.add('rotate-180');
            button.classList.add('open');
          } else {
            content.style.display = 'none';
            icon.classList.remove('rotate-180');
            button.classList.remove('open');
          }
        });
      });

      // ========= C√ÅLCULO DE SCORE =========
      const form = document.getElementById('inspection-form');
      form.addEventListener('change', updateResults);

      function calculateScore() {
        const weights = { A: 3, B: 2, C: 1 };
        let scoreAchieved = 0;
        let maxPossibleScore = 0;

        formItems.forEach(section => {
          section.items.forEach(item => {
            const radio = document.querySelector(`input[name="item-${item.id}"]:checked`);
            const weight = weights[item.potential] || 0;
            if (radio && (radio.value === 'C' || radio.value === 'NC')) {
              maxPossibleScore += weight;
              if (radio.value === 'C') scoreAchieved += weight;
            }
          });
        });

        if (maxPossibleScore === 0) return { percentage: 0, concept: 'IMPEDIDO', scoreAchieved: 0, maxPossibleScore: 0 };
        const percentage = (scoreAchieved / maxPossibleScore) * 100;

        let concept = '';
        if (percentage < 50) concept = 'IMPEDIDO';
        else if (percentage < 60) concept = 'P√âSSIMO';
        else if (percentage < 70) concept = 'RUIM';
        else if (percentage < 80) concept = 'REGULAR';
        else if (percentage < 90) concept = 'OPORTUNIDADE DE MELHORIAS';
        else concept = '√ìTIMO';

        return { percentage, concept, scoreAchieved, maxPossibleScore };
      }

      function updateResults() {
        const { percentage, concept } = calculateScore();
        const resultContainer = document.getElementById('result-container');
        const percentageText = document.getElementById('percentage-text');
        const resultBar = document.getElementById('result-bar');
        const conceptBadge = document.getElementById('concept-badge');

        resultContainer.classList.remove('hidden');
        percentageText.textContent = `${percentage.toFixed(2)}%`;
        resultBar.style.width = `${percentage}%`;

        conceptBadge.textContent = concept.replace('OPORTUNIDADE DE MELHORIAS', 'MELHORIAS');
        conceptBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold ';

        const conceptClasses = {
          'IMPEDIDO': 'concept-impedido',
          'P√âSSIMO': 'concept-pessimo',
          'RUIM': 'concept-ruim',
          'REGULAR': 'concept-regular',
          'OPORTUNIDADE DE MELHORIAS': 'concept-melhorias',
          '√ìTIMO': 'concept-otimo',
          'ERRO': 'concept-erro'
        };
        if (conceptClasses[concept]) conceptBadge.classList.add(conceptClasses[concept]);

        const barColors = {
          'IMPEDIDO': 'bg-red-500',
          'P√âSSIMO': 'bg-amber-700',
          'RUIM': 'bg-orange-500',
          'REGULAR': 'bg-yellow-500',
          'OPORTUNIDADE DE MELHORIAS': 'bg-lime-500',
          '√ìTIMO': 'bg-green-500',
          'ERRO': 'bg-gray-500'
        };
        resultBar.className = `h-4 rounded-full result-bar ${barColors[concept] || 'bg-gray-400'}`;
      }

    // ========= GERA√á√ÉO DO PDF ATUALIZADA =========
    document.getElementById('generate-pdf').addEventListener('click', function() {
      const jspdfNs = window.jspdf;
      if (!jspdfNs || !jspdfNs.jsPDF) {
        console.error('jsPDF n√£o carregado. Verifique o CDN e a ordem dos scripts.');
        alert('jsPDF n√£o foi carregado. Confira o console.');
        return;
      }
      const { jsPDF } = jspdfNs;

      (async function generate() {
        const doc = new jsPDF();
        
        // Tenta recarregar o logo antes de gerar o PDF para garantir que temos a vers√£o mais recente
        const currentLogoDataUrl = await loadLogoWithFallback();

        const addHeader = () => {
          if (currentLogoDataUrl) {
            try { 
              // Adiciona o logo com tratamento de erro
              doc.addImage(currentLogoDataUrl, 'PNG', 14, 6, 25, 7);
            } catch (e) { 
              console.log('Erro ao adicionar logo no PDF:', e);
              // Adiciona um placeholder se o logo falhar
              doc.setFillColor(30, 64, 175);
              doc.rect(14, 6, 25, 7, 'F');
              doc.setTextColor(255, 255, 255);
              doc.setFontSize(6);
              doc.text('LOGO', 19, 10);
              doc.setTextColor(0, 0, 0);
            }
          }
          doc.setFontSize(16);
          doc.setFont('helvetica', 'bold');
          doc.text('INSPE√á√ÉO SEMANAL DE SEGURAN√áA (ISS)', doc.internal.pageSize.getWidth() / 2, 12, { align: 'center' });
          doc.setFontSize(10);
          doc.setFont('helvetica', 'normal');
          doc.text('GEST√ÉO DE SEGURAN√áA E SA√öDE PARA CONTRATADAS DE INVESTIMENTOS', doc.internal.pageSize.getWidth() / 2, 18, { align: 'center' });
        };

          const addGeneralInfo = () => {
            const dateInput = document.getElementById('data');
            const dateStr = dateInput && (dateInput.value || '');
            doc.autoTable({
              startY: 25,
              theme: 'grid',
              body: [
                [{ content: `Ger√™ncia: ${document.getElementById('gerencia').value}` }, { content: `N¬∞ do Contrato: ${document.getElementById('contrato').value}` }],
                [{ content: `Administrador de Contrato: ${document.getElementById('admin_contrato').value}` }, { content: `Obra: ${document.getElementById('obra').value}` }],
                [{ content: `Engenheiro / Supervisor: ${document.getElementById('engenheiro').value}\nMatricula Bancodoc: ${document.getElementById('matricula_engenheiro').value}`, styles: { valign: 'middle' } },
                 { content: `Profissional do SESMT: ${document.getElementById('sesmt').value}\nMatricula Bancodoc: ${document.getElementById('matricula_sesmt').value}`, styles: { valign: 'middle' } }],
                [{ content: `Descri√ß√£o das Atividades: ${document.getElementById('atividades').value}`, colSpan: 2 }],
                [{ content: `NP: ${document.getElementById('np').value}` }, { content: `Inspe√ß√£o No.: ${document.getElementById('inspecao_no').value}` }],
                [{ content: `Data: ${dateStr}` }, { content: `Hora: ${document.getElementById('hora').value}` }],
              ],
              styles: { fontSize: 9, font: 'helvetica', fontStyle: 'bold', cellPadding: 1.5 }
            });
            return (doc.lastAutoTable && doc.lastAutoTable.finalY) || 25;
          };

          const addResultSummary = (startY) => {
            const { percentage, concept } = calculateScore();
            let currentY = startY + 5;
            if (currentY > 220) { doc.addPage(); addHeader(); currentY = 25; }

            const pageW = doc.internal.pageSize.getWidth();
            const boxH = 20;
            doc.setDrawColor(0);
            doc.setLineWidth(0.5);
            doc.rect(10, currentY, pageW - 20, boxH);

            doc.setFontSize(10); doc.setFont('helvetica', 'bold');
            doc.text('PERCENTAGEM ALCAN√áADA:', 15, currentY + 8);
            doc.setFontSize(12);
            doc.text(`${percentage.toFixed(2)}%`, 75, currentY + 8);

            doc.setFontSize(10);
            doc.text('CONCEITO:', 15, currentY + 15);
            doc.setFontSize(12);
            doc.text(concept.replace('OPORTUNIDADE DE MELHORIAS', 'MELHORIAS'), 40, currentY + 15);

            return currentY + boxH + 5;
          };

          const addFormTables = (startY) => {
            let currentY = startY;
            formItems.forEach(section => {
              const isSectionAnswered = section.items.some(item => document.querySelector(`input[name="item-${item.id}"]:checked`));
              if (!isSectionAnswered) return;

              const body = section.items.map(item => {
                const radio = document.querySelector(`input[name="item-${item.id}"]:checked`);
                if (!radio) return null;
                return [
                  { content: item.id },
                  { content: item.text },
                  { content: item.barrier },
                  { content: item.potential, styles: { halign: 'center' } },
                  { content: radio.value === 'C' ? 'X' : '', styles: { halign: 'center' } },
                  { content: radio.value === 'NC' ? 'X' : '', styles: { halign: 'center' } },
                  { content: radio.value === 'NA' ? 'X' : '', styles: { halign: 'center' } },
                ];
              }).filter(Boolean);

              if (body.length === 0) return;

              const approxHeight = (body.length + 2) * 8 + 10;
              const pageH = doc.internal.pageSize.getHeight();
              if (currentY + approxHeight > pageH - 20) {
                doc.addPage();
                addHeader();
                currentY = 25;
              }

              doc.autoTable({
                startY: currentY,
                head: [[{ content: section.category, colSpan: 7, styles: { fillColor: [255, 193, 7], textColor: 0, fontStyle: 'bold' } }]],
                theme: 'grid',
                styles: { fontSize: 8 }
              });

              doc.autoTable({
                startY: (doc.lastAutoTable && doc.lastAutoTable.finalY) || currentY,
                head: [['ITEM', 'CONDI√á√ÉO', 'BARREIRA', 'POTENCIAL', 'C', 'NC', 'NA']],
                body,
                theme: 'grid',
                headStyles: { fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold', fontSize: 8 },
                styles: { fontSize: 8, cellPadding: 1 },
                columnStyles: {
                  0: { cellWidth: 12 }, 1: { cellWidth: 88 }, 2: { cellWidth: 20 }, 3: { cellWidth: 16 },
                  4: { cellWidth: 8 }, 5: { cellWidth: 8 }, 6: { cellWidth: 8 }
                }
              });

              currentY = (doc.lastAutoTable && doc.lastAutoTable.finalY) ? (doc.lastAutoTable.finalY + 5) : currentY + 10;
            });
            return currentY;
          };

          function calculateLossPercentages() {
            const weights = { A: 3, B: 2, C: 1 };
            let totalWeight = 0;
            let ncWeightA = 0, ncWeightB = 0, ncWeightC = 0;
            let totalNcWeight = 0;

            formItems.forEach(section => {
              section.items.forEach(item => {
                const radio = document.querySelector(`input[name="item-${item.id}"]:checked`);
                const weight = weights[item.potential] || 0;
                
                if (radio && (radio.value === 'C' || radio.value === 'NC')) {
                  totalWeight += weight;
                  
                  if (radio.value === 'NC') {
                    totalNcWeight += weight;
                    
                    if (item.potential === 'A') ncWeightA += weight;
                    else if (item.potential === 'B') ncWeightB += weight;
                    else if (item.potential === 'C') ncWeightC += weight;
                  }
                }
              });
            });

            const percNcA = totalWeight > 0 ? (ncWeightA / totalWeight) * 100 : 0;
            const percNcB = totalWeight > 0 ? (ncWeightB / totalWeight) * 100 : 0;
            const percNcC = totalWeight > 0 ? (ncWeightC / totalWeight) * 100 : 0;
            const percAchieved = totalWeight > 0 ? ((totalWeight - totalNcWeight) / totalWeight) * 100 : 0;

            return { percNcA, percNcB, percNcC, percAchieved };
          }

          const addPieChartAndNonConfs = async (startY) => {
            const lossPercentages = calculateLossPercentages();
            let currentY = startY;

            const pageH = doc.internal.pageSize.getHeight();
            const needed = 120;
            if (currentY + needed > pageH - 20) { doc.addPage(); addHeader(); currentY = 25; }

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('Resumo (Gr√°fico)', 14, currentY + 5);
            currentY += 8;

            const off = document.createElement('canvas');
            off.width = 320; off.height = 180;
            const ctx = off.getContext('2d');

            if (window.Chart && window.Chart.plugins) {
              window.Chart.register(window['chartjs-plugin-3d']);
            }

            const chart = new Chart(ctx, {
              type: 'pie',
              data: {
                labels: [
                  `Conformidades: ${lossPercentages.percAchieved.toFixed(1)}%`,
                  `NC Severidade A: ${lossPercentages.percNcA.toFixed(1)}%`,
                  `NC Severidade B: ${lossPercentages.percNcB.toFixed(1)}%`,
                  `NC Severidade C: ${lossPercentages.percNcC.toFixed(1)}%`
                ],
                datasets: [{
                  data: [
                    lossPercentages.percAchieved,
                    lossPercentages.percNcA,
                    lossPercentages.percNcB,
                    lossPercentages.percNcC
                  ],
                  backgroundColor: ['#22C55E', '#EF4444', '#60A5FA', '#F59E0B'],
                  borderColor: ['#FFFFFF','#FFFFFF','#FFFFFF','#FFFFFF'],
                  borderWidth: 2
                }]
              },
              options: {
                responsive: false,
                animation: false,
                plugins: {
                  legend: { 
                    display: true, 
                    position: 'right',
                    labels: { font: { size: 10 }, color: '#000' }
                  },
                  tooltip: { enabled: false },
                  '3d': { enabled: true, alpha: 15, beta: 15 }
                }
              }
            });

            const chartImage = off.toDataURL('image/png');
            chart.destroy();
            off.remove();

            const imgW = 120, imgH = 68;
            doc.addImage(chartImage, 'PNG', 14, currentY, imgW, imgH);
            currentY += imgH + 10;

            doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
            doc.text('N√£o Conformidades Encontradas', 14, currentY);
            currentY += 4;

            doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            const raw = (document.getElementById('nao_conformidades').value || '').trim();
            const text = raw.length ? raw : 'Sem registros.';
            const wrapped = doc.splitTextToSize(text, doc.internal.pageSize.getWidth() - 20);

            let y = currentY + 4;
            wrapped.forEach(line => {
              if (y > pageH - 15) { doc.addPage(); addHeader(); y = 25; }
              doc.text(line, 14, y);
              y += 6;
            });
          };

          // ==== EXECU√á√ÉO ====
        addHeader();
        const infoY = addGeneralInfo();
        const afterSummary = addResultSummary(infoY);
        const afterTables = addFormTables(afterSummary);
        await addPieChartAndNonConfs(afterTables);

        const nome = document.getElementById('inspecao_no').value || 'report';
        doc.save(`iss_${nome}.pdf`);
      })().catch(err => {
        console.error('Erro ao gerar PDF:', err);
        alert('Ocorreu um erro ao gerar o PDF. Verifique o console.');
      });
    });
  });
</script>
  </script>
</body>
</html>